{"version":3,"file":"StopsFinder.js","sources":["../../../src/components/StopsFinder/StopsFinder.js"],"sourcesContent":["import React, { useMemo, useState, useEffect } from 'react';\nimport PropTypes from 'prop-types';\nimport { Autocomplete } from '@material-ui/lab';\nimport { FaSearch } from 'react-icons/fa';\nimport TextField from '@material-ui/core/TextField';\nimport CircularProgress from '@material-ui/core/CircularProgress';\nimport StopsFinderControl from 'mobility-toolbox-js/ol/controls/StopsFinderControl';\nimport { Map } from 'ol';\nimport { makeStyles } from '@material-ui/core';\nimport StopsFinderOptions from './StopsFinderOption';\n\nconst useStyles = makeStyles(() => {\n  return {\n    popupIndicatorOpen: {\n      transform: 'rotate(0)',\n    },\n  };\n});\n\nfunction StopsFinder({\n  agencies,\n  apiKey,\n  autocompleteProps,\n  bbox,\n  field,\n  limit,\n  map,\n  mots,\n  onSelect,\n  radius,\n  refLocation,\n  renderAutocomplete,\n  url,\n}) {\n  const classes = useStyles();\n  const [inputValue, setInputValue] = useState('');\n  const [suggestions, setSuggestions] = useState([]);\n  const [isLoading, setLoading] = useState(false);\n  const [isOpen, setOpen] = useState(false);\n\n  const control = useMemo(() => {\n    return new StopsFinderControl({\n      url,\n      apiKey,\n      target: document.createElement('div'),\n      element: document.createElement('div'),\n      render(newSuggestions = []) {\n        setSuggestions(newSuggestions);\n        setLoading(false);\n      },\n    });\n  }, [apiKey, url]);\n\n  useEffect(() => {\n    if (!inputValue) {\n      setSuggestions([]);\n      setLoading(false);\n      return () => {};\n    }\n    const abortController = new AbortController();\n    setLoading(true);\n    control.apiParams = {\n      prefAgencies: agencies && agencies.toString(),\n      bbox: bbox && bbox.toString(),\n      field: field && field.toString(),\n      limit,\n      mots: mots && mots.toString(),\n      radius,\n      ref_location: refLocation && refLocation.toString(),\n    };\n    control.search(inputValue, abortController);\n    return () => {\n      abortController.abort();\n    };\n  }, [\n    agencies,\n    bbox,\n    control,\n    field,\n    inputValue,\n    limit,\n    mots,\n    radius,\n    refLocation,\n  ]);\n\n  // Ensure the control is not associated to the wrong map\n  useEffect(() => {\n    if (!control) {\n      return () => {};\n    }\n\n    control.map = map;\n\n    return () => {\n      control.map = null;\n    };\n  }, [map, control]);\n\n  if (!control) {\n    return null;\n  }\n\n  if (renderAutocomplete) {\n    return renderAutocomplete(\n      suggestions,\n      inputValue,\n      setInputValue,\n      isOpen,\n      setOpen,\n      isLoading,\n      setLoading,\n    );\n  }\n\n  return (\n    <Autocomplete\n      fullWidth\n      autoComplete\n      autoHighlight\n      selectOnFocus\n      getOptionLabel={(option) => option.properties.name}\n      onChange={(evt, value, reason) => {\n        if (onSelect && reason === 'select-option') {\n          onSelect(value, evt);\n        }\n      }}\n      popupIcon={<FaSearch focusable={false} size={15} />}\n      renderInput={(params) => {\n        return (\n          <TextField\n            label=\"Search stops\"\n            // eslint-disable-next-line react/jsx-props-no-spreading\n            {...{\n              ...params,\n              ...((autocompleteProps || {}).textFieldProps || {}),\n            }}\n            InputProps={{\n              ...params.InputProps,\n              endAdornment: (\n                <>\n                  {isLoading && <CircularProgress size={20} />}\n                  {params.InputProps.endAdornment}\n                </>\n              ),\n            }}\n          />\n        );\n      }}\n      renderOption={(option) => {\n        return <StopsFinderOptions option={option} />;\n      }}\n      // eslint-disable-next-line react/jsx-props-no-spreading\n      {...{ ...autocompleteProps, textFieldProps: null }}\n      classes={{ ...classes, ...autocompleteProps.classes }}\n      inputValue={inputValue}\n      open={isOpen}\n      options={suggestions}\n      loading={isLoading}\n      onOpen={() => {\n        setOpen(true);\n      }}\n      onClose={() => {\n        setOpen(false);\n      }}\n      onInputChange={(evt, val) => {\n        setInputValue(val);\n      }}\n    />\n  );\n}\n\nStopsFinder.propTypes = {\n  /**\n   * Array or a comma separated list of agencies which should be available.\n   * Order of these agencies chooses which agency will be preferred.\n   * Available values : sbb, db\n   */\n  agencies: PropTypes.oneOfType([\n    PropTypes.string,\n    PropTypes.arrayOf(PropTypes.string),\n  ]),\n\n  /**\n   * geOps api key to access the StopsFinder service.\n   */\n  apiKey: PropTypes.string,\n\n  /**\n   * Properties apply to the default [MUI Autocomplete component](https://material-ui.com/api/autocomplete/).\n   * We add a custom properties textFieldProps for the default [MUI TextField component](https://material-ui.com/api/text-field/) used by the Autocomplete.\n   */\n  autocompleteProps: PropTypes.object,\n\n  /**\n   * minX,minY,maxX,maxY coordinates in WGS84 wherein the station should lie.\n   */\n  bbox: PropTypes.oneOfType([\n    PropTypes.string,\n    PropTypes.arrayOf(PropTypes.number),\n  ]),\n\n  /**\n   * Array or a comma separated list of fields which should be used for look up.\n   * Available values : id, name, coords\n   */\n  field: PropTypes.oneOfType([\n    PropTypes.string,\n    PropTypes.arrayOf(PropTypes.string),\n  ]),\n\n  /**\n   * Control how many matches will be returned.\n   */\n  limit: PropTypes.number,\n\n  /**\n   * A map.\n   */\n  map: PropTypes.instanceOf(Map).isRequired,\n\n  /**\n   * Array or a comma separated list of mode of transpaorts which should be available.\n   * Available values : bus, ferry, gondola, tram, rail, funicular, cable_car, subway\n   */\n  mots: PropTypes.oneOfType([\n    PropTypes.string,\n    PropTypes.arrayOf(PropTypes.string),\n  ]),\n\n  /**\n   * Function called when a suggestion is selected.\n   */\n  onSelect: PropTypes.func,\n\n  /**\n   * Radius around refLocation in meters that is most relevant.\n   * Used as granularity for location rank.\n   */\n  radius: PropTypes.number,\n\n  /**\n   * Coordinates in WGS84 (in lat,lon order) used to rank stops close to this position higher.\n   * Available values : id, name, coords\n   */\n  refLocation: PropTypes.oneOfType([\n    PropTypes.string,\n    PropTypes.arrayOf(PropTypes.number),\n  ]),\n\n  /**\n   * Function to render a different autocomplete input than the default one.\n   */\n  renderAutocomplete: PropTypes.func,\n\n  /**\n   * Url of the geOps StopsFinder service.\n   */\n  url: PropTypes.string,\n};\n\nStopsFinder.defaultProps = {\n  agencies: null,\n  apiKey: null,\n  autocompleteProps: {},\n  bbox: null,\n  field: null,\n  limit: null,\n  mots: null,\n  onSelect: null,\n  radius: null,\n  refLocation: null,\n  url: null,\n  renderAutocomplete: null,\n};\n\nexport default StopsFinder;\n"],"names":["const"],"mappings":"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"}