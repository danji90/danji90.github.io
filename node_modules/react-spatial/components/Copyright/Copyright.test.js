import 'jest-canvas-mock';
import React from 'react';
import { configure, mount } from 'enzyme';
import Adapter from 'enzyme-adapter-react-16';
import { act } from 'react-dom/test-utils';
import { Map, View } from 'ol';
import Tile from 'ol/Tile';
import TileLayer from 'ol/layer/Tile';
import TileSource from 'ol/source/Tile';
import { createXYZ } from 'ol/tilegrid';
import Layer from 'mobility-toolbox-js/ol/layers/Layer';
import Copyright from './Copyright';

configure({ adapter: new Adapter() });

var image = new Image();
image.width = 256;
image.height = 256;

var tileLoadFunction = function () {
  var tile = new Tile([0, 0, -1], 2 /* LOADED */);
  tile.getImage = function () {
    return image;
  };
  return tile;
};

var getOLTileLayer = function () {
  var layer = new TileLayer({
    source: new TileSource({
      projection: 'EPSG:3857',
      tileGrid: createXYZ(),
    }),
  });
  layer.getSource().getTile = tileLoadFunction;
  return layer;
};

var getLayer = function (copyrights, visible) {
  if ( visible === void 0 ) visible = true;

  return new Layer({
    visible: visible,
    copyrights: copyrights,
    olLayer: getOLTileLayer(),
  });
};

var layers;
var map;

describe('Copyright', function () {
  beforeEach(function () {
    var target = document.createElement('div');
    document.body.appendChild(target);
    layers = [getLayer('bar'), getLayer('foo', false)];
    map = new Map({
      target: target,
      view: new View({
        center: [0, 0],
        zoom: 0,
      }),
      layers: layers.map(function (layer) { return layer.olLayer; }),
    });
    map.setSize([200, 200]);
    layers.forEach(function (layer) {
      layer.init(map);
    });
    act(function () {
      map.renderSync();
    });
  });

  afterEach(function () {
    map.setTarget(null);
    map = null;
  });

  test('is empty if no layers are visible', function () {
    var component = mount(React.createElement( Copyright, { map: map }));
    expect(component.html()).toBe(null);
  });

  test('displays one copyright', function () {
    var wrapper = mount(React.createElement( Copyright, { map: map }));
    act(function () {
      map.renderSync();
    });
    wrapper.update();
    expect(wrapper.text()).toBe('bar');
  });

  test('displays 2 copyrights', function () {
    var wrapper = mount(React.createElement( Copyright, { map: map }));
    layers[0].setVisible(true);
    layers[1].setVisible(true);
    act(function () {
      map.renderSync();
    });
    wrapper.update();
    expect(wrapper.text()).toBe('bar | foo');
  });

  test('displays a copyright using a custom format', function () {
    var wrapper = mount(
      React.createElement( Copyright, {
        map: map, format: function (copyrights) { return ("Number of copyrights: " + (copyrights.length)); } })
    );

    act(function () {
      map.renderSync();
    });
    wrapper.update();

    expect(wrapper.text()).toBe('Number of copyrights: 1');
  });

  test('set a custom className', function () {
    var wrapper = mount(React.createElement( Copyright, { map: map, className: "foo" }));
    expect(wrapper.find('.foo').length).toBe(1);
  });

  test('set a custom attribute to the root element', function () {
    var wrapper = mount(React.createElement( Copyright, { map: map, foo: "bar" }));
    expect(wrapper.find('[foo]').length).toBe(1);
  });
});

//# sourceMappingURL=Copyright.test.js.map