{"version":3,"file":"LayerService.js","sources":["../src/LayerService.js"],"sourcesContent":["import { unByKey } from 'ol/Observable';\n\n/**\n * A layer service class to handle layer adding, removing and visiblity.\n */\nexport default class LayerService {\n  constructor(layers) {\n    this.layers = layers;\n    this.callbacks = {};\n    this.keys = [];\n    this.listenChangeEvt();\n  }\n\n  addLayer(layer) {\n    this.layers.push(layer);\n  }\n\n  getLayers() {\n    return this.layers;\n  }\n\n  setLayers(layers) {\n    this.layers = layers;\n    this.listenChangeEvt();\n    // When we change the layers we trigger an change:layers event\n    (this.callbacks['change:layers'] || []).forEach((cb) => cb(layers));\n  }\n\n  getLayersAsFlatArray(optLayers) {\n    let layers = [];\n    (optLayers || this.getLayers() || []).forEach((l) => {\n      layers.push(l);\n      const { children } = l;\n      layers = layers.concat(this.getLayersAsFlatArray(children));\n    });\n    return layers;\n  }\n\n  getLayer(name) {\n    return this.getLayersAsFlatArray().find((l) => l.name === name);\n  }\n\n  getParent(child) {\n    return this.getLayersAsFlatArray().find(\n      (l) => !!l.children.includes(child),\n    );\n  }\n\n  getParents(child) {\n    let layer = child;\n    const parents = [];\n\n    let parentLayer;\n    do {\n      parentLayer = this.getParent(layer);\n      if (parentLayer) {\n        parents.push(parentLayer);\n        layer = parentLayer;\n      }\n    } while (parentLayer);\n\n    return parents;\n  }\n\n  getRadioGroupLayers(radioGroupName) {\n    if (radioGroupName) {\n      return this.getLayersAsFlatArray().filter(\n        (l) => l.get('radioGroup') === radioGroupName,\n      );\n    }\n\n    return null;\n  }\n\n  getBaseLayers() {\n    return this.getLayersAsFlatArray().filter((l) => l.isBaseLayer);\n  }\n\n  getQueryableLayers() {\n    return this.getLayersAsFlatArray().filter(\n      (layer) => layer.visible && layer.isQueryable,\n    );\n  }\n\n  getFeatureInfoAtCoordinate(coordinate, layers) {\n    const promises = (layers || this.getQueryableLayers()).map((layer) => {\n      return layer\n        .getFeatureInfoAtCoordinate(coordinate)\n        .then((featureInfo) => {\n          return featureInfo;\n        });\n    });\n    return Promise.all(promises);\n  }\n\n  on(evt, callback) {\n    this.un(evt, callback);\n    this.callbacks[evt] = this.callbacks[evt] || [];\n    this.callbacks[evt].push(callback);\n  }\n\n  un(evt, callback) {\n    for (let i = 0; i < (this.callbacks[evt] || []).length; i += 1) {\n      if (callback === this.callbacks[evt][i]) {\n        this.callbacks[evt].splice(i, 1);\n        break;\n      }\n    }\n  }\n\n  listenChangeEvt() {\n    if (this.keys) {\n      unByKey(this.keys);\n      this.keys = [];\n    }\n    this.getLayersAsFlatArray().forEach((layer) => {\n      this.keys.push(\n        layer.on('change:copyright', (evt) => {\n          (this.callbacks['change:copyright'] || []).forEach((cb) =>\n            cb(evt.target),\n          );\n        }),\n        layer.on('change:visible', (evt) => {\n          const { visible } = evt.target;\n\n          // Apply to siblings only if it's a radio group.\n          if (\n            !evt.stopPropagationSiblings &&\n            layer.get('radioGroup') &&\n            visible\n          ) {\n            const siblings = this.getRadioGroupLayers(\n              layer.get('radioGroup'),\n            ).filter((l) => l !== layer);\n\n            siblings.forEach((s) => {\n              if (\n                visible &&\n                s.get('radioGroup') &&\n                evt.target.get('radioGroup') === s.get('radioGroup')\n              ) {\n                s.setVisible(false, false, true, true);\n              }\n            });\n          }\n\n          // Apply to children\n          if (!evt.stopPropagationDown && layer.children) {\n            layer.children.forEach((child) => {\n              child.setVisible(visible, false, true, false);\n            });\n          }\n\n          // Apply to parent only if:\n          //   - a child is visible\n          //   - all children are hidden\n          const parentLayer = this.getParent(layer);\n\n          if (\n            !evt.stopPropagationUp &&\n            parentLayer &&\n            (visible ||\n              (!visible && !parentLayer.children.find((c) => c.visible)))\n          ) {\n            parentLayer.setVisible(visible, true, false, false);\n          }\n\n          (this.callbacks['change:visible'] || []).forEach((cb) =>\n            cb(evt.target),\n          );\n        }),\n      );\n    });\n  }\n}\n"],"names":["let","const","this"],"mappings":"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"}